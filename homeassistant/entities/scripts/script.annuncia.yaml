annuncia:
  sequence:
    - condition: state
      entity_id: input_boolean.annunci
      state: 'on'
    - service: var.set
      entity_id: var.alexa_volume
      data_template:
        value: >
          {{ state_attr("media_player.echo_dot_della_sala", "volume_level") }}
    - service: var.set
      entity_id: var.last_announcement
      data_template:
        value: !include ../../jinja_templates/template.annuncio.yaml
    - service: media_player.volume_set 
      entity_id: media_player.echo_dot_della_sala
      data_template:
        volume_level: >
          {% if "Sera" in states.input_select.stato_del_giorno.state %}
            0.4
          {% else %}
            0.5
          {% endif %}
    - service: notify.alexa_media_echo_dot_della_sala
      data_template:
        data:
          type: announce
          method: speak
        message: >
          {{ states("var.last_announcement") }}
    - delay:
        seconds: >
          {{ (states("var.last_announcement").split(" ") | count * 0.5) | int }}
    - service: media_player.volume_set 
      entity_id: media_player.echo_dot_della_sala
      data_template:
        volume_level: >
          {{Â states("var.alexa_volume") }}